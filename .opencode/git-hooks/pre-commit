#!/usr/bin/env bash
#
# Pre-commit hook for openspace project
# Validates NSO-related changes before allowing commit
#
# Installed at: /Users/Shared/dev/openspace/.git/hooks/pre-commit
# Date: 2026-02-11
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

# Check if any NSO-critical files are being modified
NSO_CHANGES=$(echo "$STAGED_FILES" | grep -E '^\.opencode/(hooks/|context/|scripts/)' || true)

if [ -n "$NSO_CHANGES" ]; then
  echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${YELLOW}⚠️  NSO CHANGE DETECTED${NC}"
  echo -e "${YELLOW}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo ""
  echo "The following NSO-critical files are staged for commit:"
  echo ""
  echo "$NSO_CHANGES" | sed 's/^/  • /'
  echo ""
  echo -e "${YELLOW}NSO Policy:${NC} Changes to hooks, context, or scripts require explicit approval."
  echo ""
  echo "This pre-commit hook enforces the NSO Self-Improvement Protocol (instructions.md)."
  echo ""
  echo -e "${GREEN}If you have reviewed these changes and approve them:${NC}"
  echo "  • Press ENTER to proceed with the commit"
  echo ""
  echo -e "${RED}If you want to cancel:${NC}"
  echo "  • Press Ctrl+C"
  echo ""
  read -p "Proceed? "
fi

# Check if hooks or scripts have syntax errors
if echo "$STAGED_FILES" | grep -q '\.py$'; then
  echo -e "${GREEN}✓ Validating Python syntax...${NC}"
  for file in $(echo "$STAGED_FILES" | grep '\.py$'); do
    if [ -f "$file" ]; then
      python3 -m py_compile "$file" 2>&1 || {
        echo -e "${RED}✗ Syntax error in $file${NC}"
        exit 1
      }
    fi
  done
fi

if echo "$STAGED_FILES" | grep -q '\.js$'; then
  echo -e "${GREEN}✓ Validating JavaScript syntax...${NC}"
  for file in $(echo "$STAGED_FILES" | grep '\.js$'); do
    if [ -f "$file" ]; then
      node --check "$file" 2>&1 || {
        echo -e "${RED}✗ Syntax error in $file${NC}"
        exit 1
      }
    fi
  done
fi

echo -e "${GREEN}✓ Pre-commit validation passed${NC}"
exit 0
